---
title: "Mark Meeting"
author: "Sarah Hensley"
date: "2024-02-08"
output: html_document
---

```{r, echo=FALSE, message=FALSE, warning = FALSE}
# loading libraries
library(mgcv)
library(here)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(readr)
library(patchwork)

# loading in the data
here()
setwd("C:/Users/hensl/OneDrive/Documents/Winter Quarter 2024/NWAtlantic-consumption")
data_comb <- read.csv("data/updated cb ratios.csv")

# renaming species codes
data_comb$svspp[data_comb$svspp == 15] <- 'Spiny.Dogfish'
data_comb$svspp[data_comb$svspp == 23] <- 'Winter.Skate'
data_comb$svspp[data_comb$svspp == 75] <- 'Pollock'
data_comb$svspp[data_comb$svspp == 76] <- 'White.Hake'
data_comb$svspp[data_comb$svspp == 77] <- 'Red.Hake'
data_comb$svspp[data_comb$svspp == 197] <- 'Goosefish'
data_comb$svspp[data_comb$svspp == 28] <- 'Thorny.Skate'
data_comb$svspp[data_comb$svspp == 73] <- 'Atlantic.Cod'
data_comb$svspp[data_comb$svspp == 164] <- 'Sea.Raven'
data_comb$svspp[data_comb$svspp == 72] <- 'Silver.Hake'
data_comb$svspp[data_comb$svspp == 103] <- 'Summer.Flounder'
data_comb$svspp[data_comb$svspp == 104] <- 'Fourspot.Flounder'
data_comb$svspp[data_comb$svspp == 108] <- 'Windowpane'
data_comb$svspp[data_comb$svspp == 112] <- 'Buckler.Dory'
data_comb$svspp[data_comb$svspp == 135] <- 'Blue.Fish'
data_comb$svspp[data_comb$svspp == 163] <- 'Longhorn.Sculpin'
data_comb$svspp[data_comb$svspp == 172] <- 'Striped.Searobin'

# omitting all NA's
#data_comb_f <- data_comb %>% na.omit(cb)

# omitting true zeros
#data_comb_f <- data_comb_f %>% 
#  filter(CMT > 0.000000e+00)

# change all zeros to NA
data_comb$CMT[data_comb$CMT == 0] <- NA

data_comb_f <- data_comb
```

### Looking at consumption and biomass over time individually side by side
```{r, out.width='100%', fig.height=5, echo=FALSE, message = FALSE, warning = FALSE}
library(patchwork)

# creating list to save plots
dist_plots_list <- list()

# Get unique levels of svspp
svspp_levels <- unique(data_comb_f$svspp)

# Loop through svspp levels
for (svspp_level in svspp_levels) {
  # Filter data for the current svspp level
  filtered_data <- data_comb_f %>%
    filter(svspp == svspp_level & prey == "all")

  # Create the consumption plot
  dist_plot_consumption <- ggplot(filtered_data, aes(x = year, y = CMT)) +
    geom_point(stat = 'identity') +
    geom_smooth(method = lm, linewidth = 1, se = FALSE) +
    xlab("Time (year)") +
    ylab("Consumption (metric tons)") + 
    facet_wrap(~seacat, scales = "free") +
    scale_x_continuous(breaks = c(1980, 2000, 2020)) +
    theme(legend.text = element_text(size = 5)) +
    theme_bw() +
    theme(plot.title = element_text(size = 12)) +
    theme(axis.text.x = element_text(size = 8), 
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 13),
          axis.title.x = element_text(size = 13)) +
    ggtitle(paste("Consumption:", svspp_level))
  
   # Create the biomass plot
  dist_plot_biomass <- ggplot(filtered_data, aes(x = year, y = biompop)) +
    geom_point(stat = 'identity') +
    geom_smooth(method = lm, linewidth = 1, se = FALSE) +
    xlab("Time (year)") +
    ylab("Biomass (kg)") + 
    scale_x_continuous(breaks = c(1980, 2000, 2020)) +
    facet_wrap(~seacat, scales = "free") +
    theme_bw() +
    theme(plot.title = element_text(size = 12)) +
    theme(axis.text.x = element_text(size = 8), 
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 13),
          axis.title.x = element_text(size = 13)) +
    ggtitle(paste("Biomass:", svspp_level))

  # Add the plot to the list
  dist_plots_list[[svspp_level]] <- dist_plot_consumption + dist_plot_biomass
}

# Print the plots
for (dist_plot in dist_plots_list) {
  print(dist_plot)
}

```
**Questions:** 

1. For groups where the consumption and biomass are showing different trends, how do we move forward with the cb ratios (i.e. are there any adjustments we would need to make in order to use cb)

2. It appears as if the results prior to 1981 are showing both significantly more biomass and consumption; do we need to account for this or because they are both changing in the same direction we're fine?


### Looking at Consumption vs Biomass Over Time Across Predator, Prey and Seasons
```{r, out.width='100%', fig.height=15, echo=FALSE, message = FALSE, warning = FALSE}
# Create a list to store plots
dist_plots_list <- list()

# Get unique levels of svspp
svspp_levels <- unique(data_comb_f$svspp)

# Loop through svspp levels
for (svspp_level in svspp_levels) {
  # Filter data for the current svspp level
  filtered_data <- data_comb_f %>%
    filter(svspp == svspp_level)

  # Create the consumption plot
  dist_plot_consumption <- ggplot(filtered_data, aes(x = year, y = CMT)) +
    geom_point(stat = 'identity') +
    geom_smooth(method = lm, aes(color = prey), linewidth = 1, se = FALSE) +
    xlab("Time (year)") +
    ylab("Consumption (metric tons)") + 
    facet_wrap(~prey + seacat, scales = "free", nrow = 8, ncol = 2) +
    scale_x_continuous(breaks = c(1980, 2000, 2020)) +
    theme(legend.position = "none") +
    guides(color = "none") +
    theme_bw() +
    theme(plot.title = element_text(size = 10)) +
    theme(axis.text.x = element_text(size = 8), 
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 13),
          axis.title.x = element_text(size = 13)) +
    ggtitle(paste("Consumption:", svspp_level))
  
  # Create the biomass plot
  dist_plot_biomass <- filtered_data %>% 
    filter(prey == "all") %>% 
      ggplot(aes(x = year, y = biompop, fill = prey)) +
    geom_point(stat = 'identity') +
    geom_smooth(method = lm, aes(color = prey), linewidth = 1, se = FALSE) +
    xlab("Time (year)") +
    ylab("Biomass (kg)") + 
    facet_wrap(~seacat, scales = "free") +
    scale_x_continuous(breaks = c(1980, 2000, 2020)) +
    theme_bw() +
    theme(plot.title = element_text(size = 10)) +
    theme(axis.text.x = element_text(size = 8), 
          axis.text.y = element_text(size = 10),
          axis.title.y = element_text(size = 13),
          axis.title.x = element_text(size = 13)) +
    ggtitle(paste("Biomass:", svspp_level))

  # Add the plot to the list
  dist_plots_list[[svspp_level]] <- dist_plot_consumption + dist_plot_biomass
}

# Print the plots
for (dist_plot in dist_plots_list) {
  print(dist_plot)
}

```